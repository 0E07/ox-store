<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OX STORE - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            padding-top: 80px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
        }

        .admin-table th,
        .admin-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent-red);
        }

        .action-btn {
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        .btn-delete {
            background: #ff4444;
            color: white;
        }

        .btn-add {
            background: var(--accent-red);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            display: inline-block;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            width: 500px;
            max-width: 90%;
            position: relative;
            border: 1px solid var(--border-color);
        }

        /* Tab Styles */
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            font-weight: bold;
        }

        .tab-btn:hover {
            color: white;
            border-color: var(--accent-red);
        }

        .tab-btn.active {
            background: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
        }

        .status-pending {
            color: orange;
        }

        .status-approved {
            color: #28a745;
        }

        .status-rejected {
            color: #dc3545;
        }

        /* Stock Modal Specifics */
        .stock-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stock-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
            transition: 0.2s;
        }

        .stock-tab.active {
            background: #6366f1;
            /* Purple */
            color: white;
        }

        .stock-textarea {
            width: 100%;
            height: 200px;
            background: rgba(15, 17, 26, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: #ccc;
            padding: 15px;
            resize: vertical;
            font-family: monospace;
            line-height: 1.5;
        }

        .btn-purple {
            background: #6366f1 !important;
            color: white !important;
            padding: 10px 25px !important;
        }
    </style>
</head>

<body>
    <nav class="navbar" style="position: fixed; top: 0; width: 100%;">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <span class="logo-text">OX ADMIN DATAPACE</span>
                </div>
                <div>
                    <a href="index.html" class="btn-secondary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
            <div class="admin-tabs" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="switchTab('products')" class="tab-btn active" id="tab-products">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                <button onclick="switchTab('orders')" class="tab-btn" id="tab-orders">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                <button onclick="switchTab('history')" class="tab-btn" id="tab-history">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                <button onclick="switchTab('exchange')" class="tab-btn" id="tab-exchange">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</button>
                <button onclick="switchTab('purchases')" class="tab-btn" id="tab-purchases">Ø³Ø¬Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡</button>
                <button onclick="switchTab('users')" class="tab-btn" id="tab-users">Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                <button onclick="switchTab('permissions')" class="tab-btn" id="tab-permissions">Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ©</button>
            </div>
        </div>

        <!-- Products Section -->
        <div id="productsSection">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                <button onclick="openAddModal()" class="btn-add">Ø£Ø¶Ù Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ +</button>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ù‚Ø³Ù…</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" style="display: none;">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Username)</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID)</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº ($)</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ù„)</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø³Ù„</th>
                        <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <!-- Pending Orders will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Order History Section -->
        <div id="historySection" style="display: none;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: white; font-size: 1.5rem;">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© ÙˆØ§Ù„Ù…Ø±ÙÙˆØ¶Ø©)</h2>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº ($)</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ù„)</th>
                        <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- History will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Exchange Rate Section -->
        <div id="exchangeSection" style="display: none;">
            <div class="modal-3d-container"
                style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 30px; max-width: 600px;">
                <h2 style="margin-bottom: 25px; color: var(--accent-red);">Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù</h2>
                <form id="exchangeForm">
                    <div class="form-group">
                        <label>Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (USD) - Ø§Ù„Ø£Ø³Ø§Ø³</label>
                        <input type="number" step="0.01" id="rate-usd" required value="1.0">
                    </div>
                    <div class="form-group">
                        <label>Ø³Ø¹Ø± Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ø§Ø³ØªØ±Ù„ÙŠÙ†ÙŠ (GBP)</label>
                        <input type="number" step="0.01" id="rate-gbp" required placeholder="0.79">
                    </div>
                    <div class="form-group">
                        <label>Ø³Ø¹Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ù„ÙŠØ¨ÙŠ (LYD) - (Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù†)</label>
                        <input type="number" step="0.01" id="rate-lyd" required placeholder="13.0">
                    </div>
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">
                        * Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³Ø¹Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ù„ÙŠØ¨ÙŠ Ù‡Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø¹Ù†Ø¯ Ø·Ù„Ø¨ "Ø¥Ø¶Ø§ÙØ© Ø£Ù…ÙˆØ§Ù„".
                    </p>
                    <button type="submit" class="btn-primary"
                        style="width: 100%; justify-content: center; background: var(--accent-red); padding: 12px; border: none; border-radius: 10px; color: white; cursor: pointer;">Ø­ÙØ¸
                        Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                </form>
            </div>
        </div>

        <!-- Purchases Log Section -->
        <div id="purchasesSection" style="display: none;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: white; font-size: 1.5rem;">Ø³Ø¬Ù„ Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="purchasesTableBody">
                    <!-- Purchases will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Permissions Section -->
        <div id="permissionsSection" style="display: none;">
            <div class="modal-3d-container"
                style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
                <h2 style="margin-bottom: 25px; color: var(--accent-red);">Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</h2>
                <form id="permissionForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <select id="userSelector" required
                                style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
                                <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</option>
                            </select>
                        </div>
                        <div class="form-group"
                            style="display: flex; flex-direction: column; gap: 10px; justify-content: center;">
                            <label style="margin-bottom: 10px;">Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <label
                                    style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" id="p-products"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" id="p-orders"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" id="p-exchange"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" id="p-admins"> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; color: var(--accent-red); font-weight: bold;">
                                    <input type="checkbox" id="p-dashboard"> Ø¸Ù‡ÙˆØ± Ø²Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                                </label>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary"
                        style="margin-top: 20px; width: 100%; justify-content: center; background: var(--accent-red);">Ø­ÙØ¸
                        Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
                </form>
            </div>

            <h3 style="color: white; margin-bottom: 15px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                        <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                        <th>Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</th>
                        <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</th>
                        <th>Ø²Ø± Ø§Ù„Ù„ÙˆØ­Ø©</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="adminsTableBody"></tbody>
            </table>
        </div>

        <!-- User Balance Section -->
        <div id="usersSection" style="display: none;">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: white; font-size: 1.5rem;">Ø¥Ø¯Ø§Ø±Ø© Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
                <div style="position: relative; width: 300px;">
                    <input type="text" id="userSearchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ID..."
                        style="width: 100%; padding: 10px 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
                </div>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>ID</th>
                        <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                        <th>ØªØ¹Ø¯ÙŠÙ„ Ø³Ø±ÙŠØ¹</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Stock Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content" style="width: 600px; background: #0f111a; border: 1px solid #2d2f36;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: white; font-weight: bold; font-size: 20px;">Set Stock (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)</h2>
            </div>

            <div class="stock-tabs">
                <button class="stock-tab active" id="tab-stock-add" onclick="switchStockTab('add')">Add (Ø¥Ø¶Ø§ÙØ©)</button>
                <button class="stock-tab" id="tab-stock-update" onclick="switchStockTab('update')">Update
                    (ØªØ­Ø¯ÙŠØ«)</button>
            </div>

            <div class="form-group">
                <label style="color: white; font-weight: bold;">New Deliverables (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)</label>
                <small style="color: #6b7280; display: block; margin-bottom: 10px; font-size: 13px;">
                    Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ÙƒÙ„ <b>3 Ø£Ø³Ø·Ø±</b> ÙŠÙ…Ø«Ù„ÙˆÙ† Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯. Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ø³ÙŠØ­ØµÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ 3 Ø£Ø³Ø·Ø± Ù…ØªÙˆÙØ±Ø©.
                    <br>
                    (Every 3 lines = 1 product)
                </small>
                <textarea id="stockData" class="stock-textarea"
                    placeholder="Line 1 (Email)&#10;Line 2 (Password)&#10;Line 3 (Backup Code)&#10;Line 4 (Email)..."></textarea>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                <button onclick="closeStockModal()"
                    style="background: transparent; border: 1px solid #374151; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button onclick="saveStock()" class="btn-purple"
                    style="border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
            <form id="addForm">
                <div class="form-group">
                    <label>ID (Ù…Ù…ÙŠØ²)</label>
                    <input type="text" name="id" required placeholder="ex: pubg-uc">
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù‚Ø³Ù…</label>
                    <select name="category">
                        <option value="fivem">FiveM</option>
                        <option value="discord">Discord</option>
                        <option value="accounts">Accounts</option>
                        <option value="programming">Programming</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ø¹Ø± ($)</label>
                    <input type="number" step="0.01" name="price" required>
                </div>
                <div class="form-group">
                    <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="file" name="imageFile" id="addImageFile" accept="image/*" style="margin-bottom: 10px;">
                    <div id="addImagePreview" style="margin-top: 10px; display: none;">
                        <img id="addPreviewImg" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©"
                            style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);">
                    </div>
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø·
                        Ø®Ø§Ø±Ø¬ÙŠ:</small>
                    <input type="text" name="imageUrl" id="addImageUrl" placeholder="https://example.com/image.jpg"
                        style="margin-top: 5px;">
                </div>
                <!-- Added Badge Field to Add Form -->
                <div class="form-group">
                    <label>Ø´Ø§Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" name="badge" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø¯ÙŠØ¯, Ø¹Ø±Ø¶ Ø®Ø§Øµ">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ</label>
                    <textarea name="description"></textarea>
                </div>
                <!-- Instant Delivery Toggle -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="instant_delivery" value="1"> ØªØ³Ù„ÙŠÙ… ÙÙˆØ±ÙŠ (ğŸš€ Instant Delivery)
                    </label>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                <button type="button" onclick="closeAddModal()" class="btn-secondary"
                    style="width: 100%; margin-top: 10px;">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2>
            <form id="editForm">
                <input type="hidden" name="id" id="edit-id">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input type="text" name="title" id="edit-title" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù‚Ø³Ù…</label>
                    <select name="category" id="edit-category">
                        <option value="fivem">FiveM</option>
                        <option value="discord">Discord</option>
                        <option value="accounts">Accounts</option>
                        <option value="programming">Programming</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ø¹Ø± ($)</label>
                    <input type="number" step="0.01" name="price" id="edit-price" required>
                </div>
                <div class="form-group">
                    <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <div id="editCurrentImage" style="margin-bottom: 10px;">
                        <label style="font-size: 12px; color: var(--text-muted);">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label>
                        <img id="editCurrentImg" src="" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©"
                            style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 1px solid var(--border-color); display: block; margin-top: 5px;">
                    </div>
                    <input type="file" name="imageFile" id="editImageFile" accept="image/*"
                        style="margin-bottom: 10px;">
                    <div id="editImagePreview" style="margin-top: 10px; display: none;">
                        <label style="font-size: 12px; color: var(--text-muted);">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                        <img id="editPreviewImg" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©"
                            style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color); display: block; margin-top: 5px;">
                    </div>
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø·
                        Ø®Ø§Ø±Ø¬ÙŠ:</small>
                    <input type="text" name="imageUrl" id="editImageUrl" placeholder="https://example.com/image.jpg"
                        style="margin-top: 5px;">
                    <input type="hidden" name="currentImage" id="edit-current-image-path">
                </div>
                <div class="form-group">
                    <label>Ø´Ø§Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" name="badge" id="edit-badge" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø¯ÙŠØ¯, Ø¹Ø±Ø¶ Ø®Ø§Øµ">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ</label>
                    <textarea name="description" id="edit-description"></textarea>
                </div>
                <!-- Instant Delivery Toggle -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="instant_delivery" id="edit-instant-delivery" value="1"> ØªØ³Ù„ÙŠÙ… ÙÙˆØ±ÙŠ
                        (ğŸš€ Instant Delivery)
                    </label>
                </div>
                <button type="submit" class="btn-primary" style="background: #28a745; width: 100%;">Ø­ÙØ¸
                    Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button type="button" onclick="closeEditModal()" class="btn-secondary"
                    style="width: 100%; margin-top: 10px;">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>

    <!-- Purchase Delivery Modal (The "Box") -->
    <div id="deliverModal" class="modal">
        <div class="modal-content" style="max-width: 500px; background: #0f111a; border: 1px solid #2d2f36;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: white; font-weight: bold; font-size: 20px;">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… #<span
                        id="deliverOrderId"></span></h2>
            </div>
            <div class="form-group">
                <label style="color: white; margin-bottom: 10px; display: block;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (Ø³ÙŠØ±Ø§Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
                    Ø¹Ù„Ù‰ Ø¹Ø±Ø¶)</label>
                <textarea id="deliverData" class="stock-textarea"
                    placeholder="Username: ...&#10;Password: ..."></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                <button onclick="closeDeliverModal()"
                    style="background: transparent; border: 1px solid #374151; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirmDeliverBtn" class="btn-purple"
                    style="border: none; border-radius: 6px; cursor: pointer; padding: 10px 25px; font-weight: bold;">Ø­ÙØ¸
                    ÙˆØªØ³Ù„ÙŠÙ…</button>
            </div>
        </div>
    </div>

    <!-- Balance Adjust Modal (The "Box") -->
    <div id="balanceModal" class="modal">
        <div class="modal-content" style="max-width: 400px; background: #0f111a; border: 1px solid #2d2f36;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: white; font-weight: bold; font-size: 20px;">ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
            </div>
            <div class="form-group">
                <label style="color: white; margin-bottom: 10px; display: block;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±ØµÙŠØ¯ ($)</label>
                <input type="number" step="0.01" id="newBalanceInput"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                <button onclick="closeBalanceModal()"
                    style="background: transparent; border: 1px solid #374151; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="saveBalanceBtn" class="btn-purple"
                    style="border: none; border-radius: 6px; cursor: pointer; padding: 10px 25px; font-weight: bold;">ØªØ­Ø¯ÙŠØ«
                    Ø§Ù„Ø±ØµÙŠØ¯</button>
            </div>
        </div>
    </div>

    <script>
        // Global list to store current products for easy access
        let currentProducts = [];
        let userPermissions = null;
        const OWNER_ID = '1259905369182830715';

        // Check Permissions on Load
        function checkAdminPermissions() {
            const user = JSON.parse(localStorage.getItem('discord_user'));
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Owner has all permissions
            if (user.id === OWNER_ID) {
                userPermissions = {
                    can_manage_products: 1,
                    can_manage_orders: 1,
                    can_manage_exchange: 1,
                    can_manage_admins: 1
                };
            } else {
                // Permissions were saved in the user object during login sync
                userPermissions = user.permissions || {
                    can_manage_products: 0,
                    can_manage_orders: 0,
                    can_manage_exchange: 0,
                    can_manage_admins: 0
                };
            }

            // Hide tabs user doesn't have access to
            if (!userPermissions.can_manage_products) {
                const tab = document.getElementById('tab-products');
                if (tab) tab.style.display = 'none';
            }
            if (!userPermissions.can_manage_orders) {
                const tabOrders = document.getElementById('tab-orders');
                if (tabOrders) tabOrders.style.display = 'none';
                const tabHistory = document.getElementById('tab-history');
                if (tabHistory) tabHistory.style.display = 'none';
            }
            if (!userPermissions.can_manage_exchange) {
                const tab = document.getElementById('tab-exchange');
                if (tab) tab.style.display = 'none';
            }
            if (!userPermissions.can_manage_admins) {
                const tabP = document.getElementById('tab-permissions');
                if (tabP) tabP.style.display = 'none';
                const tabU = document.getElementById('tab-users');
                if (tabU) tabU.style.display = 'none';
            }

            // Redirect if user has NO admin access and isn't owner
            if (!user.isAdmin && user.id !== OWNER_ID) {
                window.location.href = 'index.html';
            }

            // Set initial tab based on first available permission
            if (userPermissions.can_manage_products) switchTab('products');
            else if (userPermissions.can_manage_orders) switchTab('orders');
            else if (userPermissions.can_manage_exchange) switchTab('exchange');
            else if (userPermissions.can_manage_admins) switchTab('permissions');
        }

        // Call check on startup
        window.addEventListener('DOMContentLoaded', checkAdminPermissions);

        // Fetch and Render Products
        async function loadProducts() {
            const res = await fetch('/api/products');
            currentProducts = await res.json();
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            currentProducts.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${p.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
                    <td>${p.title}</td>
                    <td>${p.category}</td>
                    <td>$${p.price}</td>
                    <td>
                        <button onclick="openStockModal('${p.id}')" class="action-btn" style="background: #6366f1; color: white; margin-left: 5px;">Ø§Ø¶Ø§ÙØ© Ù…Ø®Ø²ÙˆÙ†</button>
                        <button onclick="openEditModal('${p.id}')" class="action-btn" style="background: #28a745; color: white; margin-left: 5px;">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="deleteProduct('${p.id}')" class="action-btn btn-delete">Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Add Product
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Check if user uploaded a file or provided URL
            const imageFile = formData.get('imageFile');
            const imageUrl = formData.get('imageUrl');

            let finalImagePath = imageUrl; // Default to URL if provided

            // If file is uploaded, upload it first
            if (imageFile && imageFile.size > 0) {
                const uploadFormData = new FormData();
                uploadFormData.append('image', imageFile);

                try {
                    const uploadRes = await fetch('/api/upload-image', {
                        method: 'POST',
                        body: uploadFormData
                    });

                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        finalImagePath = uploadData.imagePath;
                    } else {
                        showStatus('Ø®Ø·Ø£', 'âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'error');
                        return;
                    }
                } catch (err) {
                    showStatus('Ø®Ø·Ø£', 'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'error');
                    return;
                }
            }

            if (!finalImagePath) {
                showStatus('Ø®Ø·Ø£', 'âš ï¸ ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·', 'error');
                return;
            }

            const data = {
                id: formData.get('id'),
                title: formData.get('title'),
                category: formData.get('category'),
                price: formData.get('price'),
                image: finalImagePath,
                badge: formData.get('badge'),
                description: formData.get('description'),
                instant_delivery: formData.get('instant_delivery') === '1'
            };

            try {
                const res = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showStatus('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                    closeAddModal();
                    loadProducts();
                    e.target.reset();
                    document.getElementById('addImagePreview').style.display = 'none';
                } else {
                    const err = await res.json();
                    showStatus('Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.error, 'error');
                }
            } catch (err) {
                console.error(err);
            }
        });

        // Edit Product Logic
        function openEditModal(id) {
            const product = currentProducts.find(p => p.id === id);
            if (!product) return;

            document.getElementById('edit-id').value = product.id;
            document.getElementById('edit-title').value = product.title;
            document.getElementById('edit-category').value = product.category;
            document.getElementById('edit-price').value = product.price;
            document.getElementById('editImageUrl').value = product.image;
            document.getElementById('edit-current-image-path').value = product.image;
            document.getElementById('edit-description').value = product.description || '';
            document.getElementById('edit-badge').value = product.badge || '';
            document.getElementById('edit-instant-delivery').checked = product.instant_delivery === 1 || product.instant_delivery === true;

            // Show current image
            document.getElementById('editCurrentImg').src = product.image;
            document.getElementById('editImagePreview').style.display = 'none';

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Update Product Request
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const id = formData.get('id');

            // Check if user uploaded a new file or provided new URL
            const imageFile = formData.get('imageFile');
            const imageUrl = formData.get('imageUrl');
            const currentImage = formData.get('currentImage');

            let finalImagePath = currentImage; // Keep current by default

            // If new file is uploaded
            if (imageFile && imageFile.size > 0) {
                const uploadFormData = new FormData();
                uploadFormData.append('image', imageFile);

                try {
                    const uploadRes = await fetch('/api/upload-image', {
                        method: 'POST',
                        body: uploadFormData
                    });

                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        finalImagePath = uploadData.imagePath;
                    } else {
                        showStatus('Ø®Ø·Ø£', 'âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'error');
                        return;
                    }
                } catch (err) {
                    showStatus('Ø®Ø·Ø£', 'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', 'error');
                    return;
                }
            } else if (imageUrl && imageUrl !== currentImage) {
                // If new URL is provided
                finalImagePath = imageUrl;
            }

            const data = {
                id: id,
                title: formData.get('title'),
                category: formData.get('category'),
                price: formData.get('price'),
                image: finalImagePath,
                badge: formData.get('badge'),
                description: formData.get('description'),
                instant_delivery: formData.get('instant_delivery') === '1'
            };

            try {
                const res = await fetch('/api/products/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showStatus('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                    closeEditModal();
                    loadProducts();
                } else {
                    const err = await res.json();
                    showStatus('Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.error, 'error');
                }
            } catch (err) {
                console.error(err);
            }
        });

        // Delete Product
        async function deleteProduct(id) {
            showConfirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ', async () => {
                try {
                    const res = await fetch('/api/products/' + id, { method: 'DELETE' });
                    if (res.ok) {
                        showStatus('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                        loadProducts();
                    } else {
                        showStatus('Ø®Ø·Ø£', 'âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
                    }
                } catch (err) {
                    showStatus('Ø®Ø·Ø£', 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                }
            });
        }

        function openAddModal() { document.getElementById('addModal').classList.add('active'); }
        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }

        // Stock Logic
        let currentStockProductId = null;
        let currentStockAction = 'add';

        function openStockModal(id) {
            currentStockProductId = id;
            document.getElementById('stockModal').classList.add('active');
            document.getElementById('stockData').value = '';
            switchStockTab('add');
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
            currentStockProductId = null;
        }

        async function switchStockTab(action) {
            currentStockAction = action;
            document.querySelectorAll('.stock-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-stock-${action}`).classList.add('active');

            const textarea = document.getElementById('stockData');

            if (action === 'update') {
                textarea.value = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†...';
                textarea.disabled = true;
                try {
                    const res = await fetch(`/api/products/${currentStockProductId}/stock`);
                    if (res.ok) {
                        const items = await res.json();
                        textarea.value = items.join('\n');
                    } else {
                        textarea.value = '';
                        showStatus('ØªÙ†Ø¨ÙŠÙ‡', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'error');
                    }
                } catch (e) {
                    textarea.value = '';
                    console.error(e);
                } finally {
                    textarea.disabled = false;
                }
            } else {
                // Add mode: clear for new input
                textarea.value = '';
                textarea.disabled = false;
            }
        }

        async function saveStock() {
            if (!currentStockProductId) return;
            const content = document.getElementById('stockData').value.trim();
            const stockItems = content.split('\n').filter(line => line.trim() !== '');

            // For update, we might allow clearing stock, so we don't strictly enforce length > 0
            if (currentStockAction === 'add' && stockItems.length === 0) {
                showStatus('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'error');
                return;
            }

            if (stockItems.length % 3 !== 0) {
                showStatus('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡Ø§ Ù„ÙŠØ³Øª Ù…Ø¶Ø§Ø¹ÙØ§Øª Ù„Ù„Ø±Ù‚Ù… 3. ØªØ°ÙƒØ± Ø£Ù† ÙƒÙ„ 3 Ø£Ø³Ø·Ø± ÙŠÙ…Ø«Ù„ÙˆÙ† Ù…Ù†ØªØ¬Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹.', 'error');
                return;
            }

            const method = currentStockAction === 'add' ? 'POST' : 'PUT';

            try {
                const res = await fetch(`/api/products/${currentStockProductId}/stock`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stockItems })
                });

                if (res.ok) {
                    const data = await res.json();
                    showStatus('Ù†Ø¬Ø§Ø­', currentStockAction === 'add' ? 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    closeStockModal();
                } else {
                    const err = await res.json();
                    showStatus('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + err.error, 'error');
                }
            } catch (e) {
                showStatus('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                console.error(e);
            }
        }

        // Initial Load
        loadProducts();

        // --- Orders Logic & Tabs ---

        // Fetch and Render Orders
        async function loadOrders() {
            const pendingTbody = document.getElementById('ordersTableBody');
            const historyTbody = document.getElementById('historyTableBody');

            try {
                const res = await fetch('/api/admin/orders?t=' + Date.now());
                if (!res.ok) throw new Error(`Server error: ${res.status}`);

                const orders = await res.json();
                pendingTbody.innerHTML = '';
                historyTbody.innerHTML = '';

                // Filter Pending Orders
                const pendingOrders = orders.filter(o => o.status.toUpperCase() === 'PENDING' || o.status.toUpperCase() === 'WAITING');
                const historyOrders = orders.filter(o => o.status.toUpperCase() === 'APPROVED' || o.status.toUpperCase() === 'REJECTED');

                if (pendingOrders.length === 0) {
                    pendingTbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
                }

                if (historyOrders.length === 0) {
                    historyTbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙØ§Ø±Øº</td></tr>';
                }

                pendingOrders.forEach(order => {
                    const tr = document.createElement('tr');

                    // Display Logic for Binance vs Local
                    let amountDisplay = '';
                    let localAmountDisplay = '';
                    let paymentMethod = '';

                    console.log('Processing order:', order.id, 'Carrier:', order.carrier);

                    if (order.carrier === 'binance' || order.carrier === 'lp') {
                        paymentMethod = '<span style="color: #F3BA2F; font-weight: bold;">Binance Automatic payment</span>';
                        amountDisplay = `<span style="color: #28a745; font-weight: bold;">$${order.amount}</span>`;
                        localAmountDisplay = '<span style="color: var(--text-muted);">-</span>';
                    } else {
                        paymentMethod = '<span style="color: #22c55e;">Ù„ÙŠØ¨ÙŠØ§Ù†Ø§/Ù…Ø¯Ø§Ø±</span>';
                        amountDisplay = `<span style="color: #28a745; font-weight: bold;">$${order.amount}</span>`;
                        localAmountDisplay = `<span style="color: #fff;">${order.local_amount || '-'} Ø¯.Ù„</span>`;
                    }

                    tr.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.username || 'Unknown'}</td>
                        <td style="font-size: 11px; color: var(--text-muted);">${order.discord_id}</td>
                        <td>${amountDisplay}</td>
                        <td>${localAmountDisplay}</td>
                        <td>${order.sender_number || '-'}</td>
                        <td>${paymentMethod}</td>
                        <td class="status-${order.status.toLowerCase()}">${order.status}</td>
                        <td style="font-size: 12px;">${new Date(order.created_at).toLocaleString()}</td>
                        <td>
                            <button onclick="approveOrder('${order.id}')" class="action-btn" style="background: #28a745; color: white; margin-left: 5px;">Ù‚Ø¨ÙˆÙ„</button>
                            <button onclick="rejectOrder('${order.id}')" class="action-btn btn-delete">Ø±ÙØ¶</button>
                        </td>
                    `;
                    pendingTbody.appendChild(tr);
                });

                historyOrders.forEach(order => {
                    const tr = document.createElement('tr');
                    const statusColor = order.status === 'APPROVED' ? '#28a745' : '#dc3545';

                    let paymentMethod = '';
                    let localAmt = (order.carrier === 'binance' || order.carrier === 'lp') ? '-' : `${order.local_amount || '-'} Ø¯.Ù„`;

                    if (order.carrier === 'binance' || order.carrier === 'lp') {
                        paymentMethod = '<span style="color: #F3BA2F; font-weight: bold;">Binance Automatic payment</span>';
                    } else {
                        paymentMethod = '<span style="color: #22c55e;">Ù„ÙŠØ¨ÙŠØ§Ù†Ø§/Ù…Ø¯Ø§Ø±</span>';
                    }

                    tr.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.username || 'Unknown'}</td>
                        <td style="color: #28a745; font-weight: bold;">$${order.amount}</td>
                        <td style="color: var(--text-muted);">${localAmt}</td>
                        <td>${paymentMethod}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${order.status === 'APPROVED' ? 'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„' : 'ØªÙ… Ø§Ù„Ø±ÙØ¶'}</td>
                        <td style="font-size: 12px;">${new Date(order.created_at).toLocaleString()}</td>
                    `;
                    historyTbody.appendChild(tr);
                });

            } catch (err) {
                console.error('Error loading orders:', err);
            }
        }

        async function loadPurchases() {
            const tbody = document.getElementById('purchasesTableBody');
            try {
                const res = await fetch('/api/admin/purchases?t=' + Date.now());
                if (!res.ok) throw new Error('Server error');
                const purchases = await res.json();

                tbody.innerHTML = '';
                if (purchases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…Ø´ØªØ±ÙŠØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
                    return;
                }

                purchases.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${p.id}</td>
                        <td>${p.username} <br><small style="color: #666;">${p.discord_id}</small></td>
                        <td>${p.product_title}</td>
                        <td style="color: #28a745; font-weight: bold;">$${p.price}</td>
                        <td style="font-size: 12px;">${new Date(p.created_at).toLocaleString()}</td>
                        <td><span style="color: #28a745;">${p.status}</span></td>
                        <td>
                            <button onclick="openDeliverModal(${p.id}, '${p.order_details ? p.order_details.replace(/'/g, "\\'") : ''}')" class="action-btn" style="background: #28a745;">ØªØ³Ù„ÙŠÙ…/ØªØ¹Ø¯ÙŠÙ„</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Error loading purchases:', err);
            }
        }

        let currentDeliverId = null;
        function openDeliverModal(id, currentData) {
            currentDeliverId = id;
            document.getElementById('deliverOrderId').textContent = id;
            document.getElementById('deliverData').value = currentData || '';
            document.getElementById('deliverModal').classList.add('active');

            document.getElementById('confirmDeliverBtn').onclick = async () => {
                const order_details = document.getElementById('deliverData').value;
                try {
                    const res = await fetch(`/api/admin/purchases/${id}/deliver`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_details })
                    });
                    if (res.ok) {
                        showStatus('Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        closeDeliverModal();
                        loadPurchases();
                    }
                } catch (e) { console.error(e); }
            };
        }

        function closeDeliverModal() {
            document.getElementById('deliverModal').classList.remove('active');
            currentDeliverId = null;
        }

        // Switch Tabs
        function switchTab(tab) {
            // Permission Validation
            if (tab === 'products' && !userPermissions.can_manage_products) return;
            if ((tab === 'orders' || tab === 'history') && !userPermissions.can_manage_orders) return;
            if (tab === 'exchange' && !userPermissions.can_manage_exchange) return;
            if (tab === 'permissions' && !userPermissions.can_manage_admins) return;

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById('tab-' + tab);
            if (activeBtn) activeBtn.classList.add('active');

            const sections = ['products', 'orders', 'history', 'exchange', 'purchases', 'permissions', 'users'];
            sections.forEach(s => {
                const el = document.getElementById(s + 'Section');
                if (el) el.style.display = (s === tab) ? 'block' : 'none';
            });

            if (tab === 'products') loadProducts();
            else if (tab === 'orders' || tab === 'history') loadOrders();
            else if (tab === 'exchange') loadExchangeRates();
            else if (tab === 'purchases') loadPurchases();
            else if (tab === 'permissions') loadPermissionsData();
            else if (tab === 'users') loadUsersManagement();
        }

        let allUsersData = [];

        async function loadUsersManagement() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';

            try {
                const res = await fetch('/api/admin/all-users');
                allUsersData = await res.json();
                renderUsersTable(allUsersData);

                // Active Search
                document.getElementById('userSearchInput').oninput = (e) => {
                    const val = e.target.value.toLowerCase();
                    const filtered = allUsersData.filter(u =>
                        u.username.toLowerCase().includes(val) ||
                        u.discord_id.includes(val)
                    );
                    renderUsersTable(filtered);
                };
            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>';
            }
        }

        function getDiscordAvatar(u) {
            if (u.avatar && u.avatar.startsWith('http')) return u.avatar;
            if (u.avatar) return `https://cdn.discordapp.com/avatars/${u.discord_id}/${u.avatar}.png`;
            return `https://cdn.discordapp.com/embed/avatars/${parseInt(u.discord_id.slice(-1)) % 5}.png`;
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</td></tr>';
                return;
            }

            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="display: flex; align-items: center; gap: 10px;">
                        <img src="${getDiscordAvatar(u)}" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color);">
                        <span>${u.username}</span>
                    </td>
                    <td style="font-size: 11px; color: var(--text-muted);">${u.discord_id}</td>
                    <td style="color: #28a745; font-weight: bold; font-size: 1.1rem;">$${u.balance.toFixed(2)}</td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="quickUpdateBalance('${u.discord_id}', 1, 'add')" class="action-btn" style="background: #28a745; padding: 5px 8px;">+1</button>
                            <button onclick="quickUpdateBalance('${u.discord_id}', 5, 'add')" class="action-btn" style="background: #1e7e34; padding: 5px 8px;">+5</button>
                            <button onclick="quickUpdateBalance('${u.discord_id}', 1, 'subtract')" class="action-btn" style="background: #dc3545; padding: 5px 8px;">-1</button>
                        </div>
                    </td>
                    <td>
                        <button onclick="editBalancePrompt('${u.discord_id}', ${u.balance})" class="action-btn" style="background: #6366f1; color: white;">ØªØ¹Ø¯ÙŠÙ„ Ù…Ø®ØµØµ</button>
                        <button onclick="resetBalanceConfirm('${u.discord_id}')" class="action-btn btn-delete">ØªØµÙÙŠØ±</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function quickUpdateBalance(id, amount, action) {
            try {
                const res = await fetch('/api/admin/users/update-balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ discord_id: id, amount, action })
                });
                if (res.ok) {
                    loadUsersManagement();
                    // Optional: show toast instead of full alert for quick updates
                }
            } catch (err) {
                showStatus('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯', 'error');
            }
        }

        let currentEditUserId = null;

        function editBalancePrompt(id, current) {
            currentEditUserId = id;
            document.getElementById('newBalanceInput').value = current;
            document.getElementById('balanceModal').classList.add('active');

            document.getElementById('saveBalanceBtn').onclick = () => {
                const newVal = document.getElementById('newBalanceInput').value;
                if (newVal !== '' && !isNaN(newVal)) {
                    quickUpdateBalance(id, parseFloat(newVal), 'set');
                    closeBalanceModal();
                }
            };
        }

        function closeBalanceModal() {
            document.getElementById('balanceModal').classList.remove('active');
            currentEditUserId = null;
        }

        function resetBalanceConfirm(id) {
            showConfirm('ØªØµÙÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø±ØµÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ', () => {
                quickUpdateBalance(id, 0, 'set');
            });
        }

        async function loadPermissionsData() {
            try {
                // Load All Users for Select
                const usersRes = await fetch('/api/admin/all-users');
                const users = await usersRes.json();
                const selector = document.getElementById('userSelector');
                selector.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ --</option>';
                users.forEach(u => {
                    selector.innerHTML += `<option value="${u.discord_id}" data-name="${u.username}">${u.username} (${u.discord_id})</option>`;
                });

                // Load Current Admins
                const adminsRes = await fetch('/api/admin/list');
                const admins = await adminsRes.json();
                const tbody = document.getElementById('adminsTableBody');
                tbody.innerHTML = '';

                admins.forEach(admin => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${admin.username} <br> <small style="color: #666;">${admin.discord_id}</small></td>
                        <td>${admin.can_manage_products ? 'âœ…' : 'âŒ'}</td>
                        <td>${admin.can_manage_orders ? 'âœ…' : 'âŒ'}</td>
                        <td>${admin.can_manage_exchange ? 'âœ…' : 'âŒ'}</td>
                        <td>${admin.can_manage_admins ? 'âœ…' : 'âŒ'}</td>
                        <td>${admin.can_view_dashboard ? 'âœ…' : 'âŒ'}</td>
                        <td>
                            <button onclick="removeAdmin('${admin.discord_id}')" class="action-btn btn-delete" ${admin.discord_id === '1259905369182830715' ? 'disabled' : ''}>Ø­Ø°Ù</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
            }
        }

        document.getElementById('permissionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const selector = document.getElementById('userSelector');
            const selectedOption = selector.options[selector.selectedIndex];

            const body = {
                discord_id: selector.value,
                username: selectedOption.getAttribute('data-name'),
                p_products: document.getElementById('p-products').checked,
                p_orders: document.getElementById('p-orders').checked,
                p_exchange: document.getElementById('p-exchange').checked,
                p_admins: document.getElementById('p-admins').checked,
                p_dashboard: document.getElementById('p-dashboard').checked
            };

            if (!body.discord_id) return showStatus('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹', 'error');

            try {
                const res = await fetch('/api/admin/permissions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    showStatus('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    loadPermissionsData();
                }
            } catch (error) {
                showStatus('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª', 'error');
            }
        });

        async function removeAdmin(id) {
            showConfirm('Ø­Ø°Ù Ù…Ø³Ø¤ÙˆÙ„', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ø­Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ØŸ', async () => {
                const res = await fetch('/api/admin/permissions/' + id, { method: 'DELETE' });
                if (res.ok) {
                    showStatus('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø³Ø­Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    loadPermissionsData();
                }
            });
        }

        async function loadExchangeRates() {
            try {
                const res = await fetch('/api/settings/exchange-rates');
                const data = await res.json();
                document.getElementById('rate-usd').value = data.usd_rate || 1.0;
                document.getElementById('rate-gbp').value = data.gbp_rate || 0.79;
                document.getElementById('rate-lyd').value = data.lyd_rate || 13.0;
            } catch (err) {
                console.error('Failed to load rates:', err);
            }
        }

        document.getElementById('exchangeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                usd_rate: parseFloat(document.getElementById('rate-usd').value),
                gbp_rate: parseFloat(document.getElementById('rate-gbp').value),
                lyd_rate: parseFloat(document.getElementById('rate-lyd').value)
            };

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…
            if (isNaN(body.usd_rate) || isNaN(body.gbp_rate) || isNaN(body.lyd_rate)) {
                showStatus('Ø®Ø·Ø£', 'âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
                return;
            }

            try {
                const res = await fetch('/api/admin/settings/exchange-rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const result = await res.json();

                if (res.ok) {
                    showStatus('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    showStatus('Ø®Ø·Ø£', 'âŒ ' + (result.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'), 'error');
                }
            } catch (error) {
                console.error('Update Error:', error);
                showStatus('Ø®Ø·Ø£', 'âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
            }
        });
    </script>

    <!-- Custom Confirmation Modal -->
    <div class="confirmation-modal" id="adminConfirmModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content-wrapper" style="max-width: 450px;">
            <div class="modal-3d-container"
                style="background: #0a0a0a; border: 1px solid var(--border-color); border-radius: 20px; padding: 40px;">
                <div style="text-align: center; margin-bottom: 25px;">
                    <div
                        style="width: 60px; height: 60px; background: rgba(220, 38, 38, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        <span id="confirmIcon" style="font-size: 30px;">ğŸ›¡ï¸</span>
                    </div>
                    <h3 id="confirmTitle" style="font-size: 20px; font-weight: bold; color: white;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</h3>
                </div>
                <div id="confirmMessage"
                    style="text-align: center; color: #ccc; margin-bottom: 25px; line-height: 1.6;"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn-primary" id="adminFinalConfirmBtn"
                        style="justify-content: center; background: var(--accent-red); padding: 12px; border: none; border-radius: 10px; color: white; cursor: pointer; font-family: inherit;">ØªØ£ÙƒÙŠØ¯</button>
                    <button class="btn-secondary" id="adminCancelConfirmBtn"
                        style="justify-content: center; border: 1px solid var(--border-color); padding: 12px; border-radius: 10px; background: transparent; color: white; cursor: pointer; font-family: inherit;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Status/Alert Modal -->
    <div class="status-modal" id="adminStatusModal">
        <div class="modal-backdrop"></div>
        <div class="modal-content-wrapper" style="max-width: 400px;">
            <div class="modal-3d-container"
                style="background: #0a0a0a; border: 1px solid var(--border-color); border-radius: 20px; padding: 40px; text-align: center;">
                <div id="adminStatusIcon"
                    style="width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                </div>
                <h3 id="adminStatusTitle"
                    style="font-size: 20px; font-weight: bold; color: white; margin-bottom: 10px;">Ø±Ø³Ø§Ù„Ø©</h3>
                <p id="adminStatusMessage" style="color: #ccc; line-height: 1.6; margin-bottom: 25px;"></p>
                <button class="btn-primary" onclick="closeModal(document.getElementById('adminStatusModal'))"
                    style="width: 100%; justify-content: center; background: var(--accent-red); padding: 12px; border: none; border-radius: 10px; color: white; cursor: pointer; font-family: inherit;">Ø­Ø³Ù†Ø§Ù‹</button>
            </div>
        </div>
    </div>

    <script>
        // Helper Functions for Admin Modals
        function openModal(modal) {
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modal) {
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function showStatus(title, message, type = 'success') {
            const modal = document.getElementById('adminStatusModal');
            const icon = document.getElementById('adminStatusIcon');
            const titleEl = document.getElementById('adminStatusTitle');
            const msgEl = document.getElementById('adminStatusMessage');

            if (!modal) return;

            titleEl.textContent = title;
            msgEl.textContent = message;

            if (type === 'success') {
                icon.innerHTML = '<span style="font-size: 30px;">âœ…</span>';
                icon.style.background = 'rgba(74, 222, 128, 0.1)';
            } else {
                icon.innerHTML = '<span style="font-size: 30px;">âŒ</span>';
                icon.style.background = 'rgba(220, 38, 38, 0.1)';
            }
            openModal(modal);
        }

        function showConfirm(title, message, onConfirm) {
            const modal = document.getElementById('adminConfirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const msgEl = document.getElementById('confirmMessage');
            const finalBtn = document.getElementById('adminFinalConfirmBtn');
            const cancelBtn = document.getElementById('adminCancelConfirmBtn');

            if (!modal) return;

            titleEl.textContent = title;
            msgEl.textContent = message;

            openModal(modal);

            finalBtn.onclick = () => {
                closeModal(modal);
                onConfirm();
            };
            cancelBtn.onclick = () => closeModal(modal);
        }

        // Updated Approve Order
        async function approveOrder(orderId) {
            showConfirm('Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ØŸ', async () => {
                try {
                    const res = await fetch('/api/admin/orders/' + orderId + '/approve', { method: 'POST' });
                    const result = await res.json();
                    if (res.ok) {
                        showStatus('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
                        loadOrders();
                    } else {
                        showStatus('Ø®Ø·Ø£', 'âŒ ' + (result.error || 'ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„'), 'error');
                    }
                } catch (err) {
                    showStatus('Ø®Ø·Ø£', 'âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
                }
            });
        }

        // Updated Reject Order
        async function rejectOrder(orderId) {
            showConfirm('Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ', async () => {
                try {
                    const res = await fetch('/api/admin/orders/' + orderId + '/reject', { method: 'POST' });
                    if (res.ok) {
                        showStatus('ØªÙ… Ø§Ù„Ø±ÙØ¶', 'ğŸš« ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
                        loadOrders();
                    } else {
                        showStatus('Ø®Ø·Ø£', 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¶', 'error');
                    }
                } catch (err) {
                    showStatus('Ø®Ø·Ø£', 'âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
                }
            });
        }

        // Image Preview Handlers
        document.addEventListener('DOMContentLoaded', function () {
            // Add form image preview
            const addImageFile = document.getElementById('addImageFile');
            if (addImageFile) {
                addImageFile.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (event) {
                            document.getElementById('addPreviewImg').src = event.target.result;
                            document.getElementById('addImagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Edit form image preview
            const editImageFile = document.getElementById('editImageFile');
            if (editImageFile) {
                editImageFile.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (event) {
                            document.getElementById('editPreviewImg').src = event.target.result;
                            document.getElementById('editImagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // --- Auto-Refresh Logic (Refresh orders every 10 seconds) ---
            setInterval(() => {
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab) {
                    const tabId = activeTab.id;
                    // Auto-refresh orders and history regardless of active tab to keep data fresh
                    loadOrders();

                    // If permissions tab is active, refresh it too
                    if (tabId === 'tab-permissions') {
                        loadPermissionsData();
                    }
                    // If purchases tab is active
                    if (tabId === 'tab-purchases') {
                        loadPurchases();
                    }
                    // Products don't change often, but can be refreshed if requested or just occasionally
                    if (tabId === 'tab-products') {
                        loadProducts();
                    }
                }
            }, 3000); // 3 Seconds
        });

    </script>
</body>

</html>